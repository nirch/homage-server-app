<html>
<head>
   <title>Analytics Tests</title>
  <link rel="stylesheet" type="text/css" href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
  <link rel="stylesheet" type="text/css" href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css">    
  <script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
  <script type="text/javascript" src="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
  <link href="http://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.3.0/css/datepicker.min.css" rel="stylesheet">
  <script src="http://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.3.0/js/bootstrap-datepicker.js"></script>
  <script src="//www.google.com/jsapi"></script>
  <!-- <script src="/js/chartkick.js"></script> -->
  <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
  <script src="/js/Analytics.js"></script>
  <script src="/js/HomageD3charts.js"></script> 

  <!-- Include the plugin's CSS and JS: -->
  <script type="text/javascript" src="js/bootstrap-multiselect.js"></script>
  <link rel="stylesheet" href="css/bootstrap-multiselect.css" type="text/css"/>

  <!-- Include Tipsy + D3Linechart -->
  <link rel="stylesheet" type="text/css" href="css/d3LineChart.css">
  <script type="text/javascript" src="js/jquery.tipsy.js"></script> 
  <link href="css/tipsy.css" rel="stylesheet" type="text/css" /> 
  <script src="js/d3LineChart.js" type="text/javascript"></script> 

  <!-- Include D3PieChart -->
  <script src="js/d3PieChart.js" type="text/javascript"></script>
  <script src="js/d3pieNew.js"></script>


<style>

body {
  font: 14px sans-serif;
}
 
.bar {
  fill: steelblue;
}
 
.axis path,
.axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}

.x.axis path {
  display: none;
}

.line {
  fill: none;
  stroke: steelblue;
  stroke-width: 1.5px;
}

.arc path {
  stroke: #fff;
}


</style>
</head>

<body>
  <nav class="navbar navbar-default col-sm-12" role="navigation">
    <div class="container">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header">
          <a class="navbar-brand" href="http://www.homage.it"> <img src="https://s3.amazonaws.com/homageapp/Intro/Homage_Logo.png" height="24" width="117"> </a>
        </div>
      </div>
  </nav>

  <div class="container col-sm-12">
            <div class="hero-unit">
                <input  type="text" placeholder="start date" id="dpStartDate">
                <input  type="text" placeholder="end date" id="dpEndDate">
                <button type="button" class="btn btn-default" id="send_button">Send</button>
              
                <div class="btn-group">
                  <button type="button" id="time_resolution_button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" id="dropdownButton">
                  Day <span class="caret"></span>
                  </button>
                  <ul class="dropdown-menu" id="time_resolution" role="menu" aria-labelledby="dropdownMenu">
                   <li><a tabindex="-1" href="#">Day</a></li>
                   <li><a tabindex="-1" href="#">Week</a></li>
                   <li><a tabindex="-1" href="#">Month</a></li>
                 </ul>
               </div>

               <select class="multiselect" id="story_selector" multiple="multiple">
                
              </select>
            
            </div>

            <div class="container col-sm-6">
              <span class="label label-default" id="label-0"></span>
              <div id="chart-0" style="height: 300px;" class="line_chart"></div>
            </div>

            <div class="container col-sm-6">
              <span class="label label-default" id="label-1"></span>
              <div id="chart-1" style="height: 300px;" class="line_chart"></div>
            </div>

            <div class="container col-sm-6">
              <span class="label label-default" id="label-2"></span>
              <div id="chart-2" style="height: 300px;"></div>
            </div>

            <div class="container col-sm-6">
              <span class="label label-default" id="label-3"></span>
              <div id="chart-3" style="height: 300px;" class="line_chart"></div>
            </div>

            <div class="container col-sm-6">
              <span class="label label-default" id="label-4"></span>
              <div id="chart-4" style="height: 300px;"></div>
            </div>

            <div class="container col-sm-6">
              <span class="label label-default" id="label-5"></span>
              <div id="chart-5" style="height: 300px;" class="line_chart"></div>
            </div>

            <div class="container col-sm-6">
              <span class="label label-default" id="label-6"></span>
              <div id="chart-6" style="height: 300px;"></div>
            </div>

            
  </div>
        
        
  <script type="text/javascript">
            currentDropDownSelection = "Day"
            var colors = ["#2484c1","#0c6197","#4daa4b","#90c469","#daca61","#e4a14b","#e98125"];

            // When the document is ready
            $(document).ready(function () {
                $('#dpStartDate').datepicker({
                    format: "yyyy-mm-dd"
                }); 

                $('#story_selector').multiselect({
                            includeSelectAllOption: true,
                            enableCaseInsensitiveFiltering: true,
                            maxHeight: 300
                  });

                dp_start_date = new Date();
                dp_start_date = dp_start_date.setDate(dp_start_date.getDate()-31);
                dp_start_date = new Date(dp_start_date);

                dp_end_date = new Date();

                $('#dpStartDate').datepicker('setDate', dp_start_date);
                $('#dpStartDate').datepicker('update');
                //$('#dpStartDate').val('');
                
                $('#dpEndDate').datepicker({
                    format: "yyyy-mm-dd"
                });  

                $('#dpEndDate').datepicker('setDate', dp_end_date);
                $('#dpEndDate').datepicker('update');
                //$('#dpEndDate').val('');

                //$('#story_selector').multiselect();
                $.get('/stories', null , function(data, status, xhr){
                  json_data = $.parseJSON(data);

                  var data = [];
                  for (i = 0; i < json_data.length; i++) {
                    data_set = json_data[i];
                    story_id = data_set["_id"]["$oid"].toString();
                    story_name = data_set["name"];
                    active = data_set["active"]
                    if (active == true) data.push({"label": story_name , "value": story_id});
                  }

                  $('#story_selector').multiselect('dataprovider',data);
                });

                $('#send_button').on('click', function (e) {
                e.preventDefault();
                sd = $('#dpStartDate').val();
                ed = $('#dpEndDate').val();
                selected_stories = $('#story_selector').val();
                console.log("selected stories:")
                console.log(selected_stories);

                  $.get('/analytics', {"start_date": sd, "end_date": ed, "stories": selected_stories}, function( data, status, xhr){
                  json_data = $.parseJSON(data);
                  for (k = 0; k < json_data.length; k++)
                  {
                    data_set = json_data[k];
                    chart_type  = data_set[0];
                    data_type   = data_set[1];  
                    data_label  = data_set[2];
                    data_series = data_set[3];

                    data_for_chart = [];
                    console.log("preparing data:" + data_label);
                    console.log("pre-data")
                    console.log(data_series);

                    switch (currentDropDownSelection) {
                      case "Day":
                        data_for_chart = genDataForDaysDisplay(sd,ed,data_type,data_series);
                        break;
                      case "Week":
                        data_for_chart = genDataForWeeksDisplay(sd,ed,data_type,data_series);
                        break;
                      case "Month":
                        console.log("chose month");
                        break;
                    }

                    chart_name = "#chart-" + k;
                    label_name = "#label-" + k;
                 
                    $(label_name).text(data_label);

                    console.log("visualizing graph: " + data_label);
                    console.log("data_for_chart")
                    console.log(data_for_chart)

                    switch (data_type) {
                      case NormalFractionGraphType:
                        drawD3LineChart(data_for_chart,chart_name);
                        break;  
                      case NormalValueGraphType:                     
                        drawD3LineChart(data_for_chart,chart_name);
                        break;
                      case AvgValueGraphType:
                        drawD3LineChart(data_for_chart,chart_name);
                        break;
                      case StoryViewsGraphType:
                        innerColumns = {
                          "column1" : ["remake views","story views"],
                          "column2" : ["ios views","android views","web views"]
                        }
                        genStackedAndGroupBarChart(data_for_chart,innerColumns,chart_name);
                        break;
                      case PieChartGraphType:
                        drawD3PieChart(data_for_chart,chart_name);
                        break;
                      default:
                        console.error("undefined graph type");
                        break;  
                    }
                  
                  }
                });
                });

                $(function(){
                  $("#time_resolution li a").click(function(){

                    $("#time_resolution_button:first-child").text($(this).text());
                    val = $("#time_resolution_button:first-child").text();
                    $("#time_resolution_button:first-child").val($(this).text());

                    switch (val) {
                      case "Day":
                        console.log('performing day operation');
                        break;
                      case "Week":
                        console.log('performing week operation');
                        break;
                      case "Month":
                        console.log('performing month operation');
                        break;

                    }

                    currentDropDownSelection = val;
                  });
                });        
           });
  </script>
</body>
</html>




