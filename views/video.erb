<!DOCTYPE html>
<head>
	<title>Homage</title>
	<!-- <script type="text/javascript" src="//cdn.sublimevideo.net/js/w5ui0013.js"></script> -->

	<!-- jQuery -->
 	<script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>

	<link href="//vjs.zencdn.net/4.6/video-js.css" rel="stylesheet">
	<script src="//vjs.zencdn.net/4.6/video.js"></script>
	<style type="text/css">
  		.vjs-default-skin { color: #FF7D57; }
	</style>
	
	<!-- Latest compiled and minified CSS -->
	<link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.0/css/bootstrap.min.css">

	<!-- Optional theme -->
	<!-- <link rel="stylesheet" href="//bootswatch.com/united/bootstrap.min.css"> -->

	<!-- Latest compiled and minified JavaScript -->
	<script src="//netdna.bootstrapcdn.com/bootstrap/3.1.0/js/bootstrap.min.js"></script>

	<!-- script for creating a BSON objectID -->
	<script src="/js/Objectid.js"></script>

	<style type="text/css">
		html, body {
			height: 100%;
		}
		body {
			background-color:#f8f8f8;
		}
		nav {
			background-color: #ff7d5f !important;
		}
	</style>

	<!-- Google Analytics (only if in production) -->
	<% if ENV['RACK_ENV'] == "production" then %>
		<script>
			(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
			(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
			m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
			})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

			ga('create', 'UA-46293158-1', 'auto');
			ga('send', 'pageview');
		</script>
	<% end %>
</head>

<body>
	<nav class="navbar navbar-default" role="navigation">
	  <div class="container">
		    <!-- Brand and toggle get grouped for better mobile display -->
		    <div class="navbar-header">
		      <a class="navbar-brand" href="http://www.homage.it"> <img src="https://s3.amazonaws.com/homageapp/Intro/Homage_Logo.png" height="24" width="117"> </a>
		    </div>
	    </div>
	</nav>

	<div class="container">
		<h1>
			<% if @user["facebook"] then %>
				<%= @user["facebook"]["first_name"] %>'s remake for <%= @story["name"]%>
			<% elsif @user["email"] then %>
				<%= @user["email"].split("@")[0].slice(0,1).capitalize + @user["email"].split("@")[0].slice(1..-1) %>'s remake for <%= @story["name"]%>
			<% else %>
				Remake for <%= @story["name"]%>
			<% end %>
		</h1>

		<video id="video_1" class="video-js vjs-default-skin vjs-big-play-centered" title="<%= @story["name"] + " - " + @remake["_id"].to_s%>" 
			controls preload="auto" width="640" height="360"
			poster=<%= @remake["thumbnail"]%>
			data-setup='{"example_option":true}'>
			<source src=<%= @remake["video"]%> type='video/mp4' />
			<p class="vjs-no-js">To view this video please enable JavaScript, and consider upgrading to a web browser that <a href="http://videojs.com/html5-video-support/" target="_blank">supports HTML5 video</a></p>
		</video>
	</div>

	<script>
		var stopReported = false;
		var playReported = false;

		videojs('video_1').ready(function(){
			var myPlayer = this;
			var videoTitle = '<%= @story["name"] + " - " + @remake["_id"].to_s %>'
			var remakeId = '<%= @remake["_id"].to_s %>'
			var objectId = new ObjectId().toString();

			var trackVideoSrart = function(){
				// Tracking in our Server
				$.post('/remake/view', {"view_id":objectId, "remake_id":remakeId, "playback_event":0, "originating_screen":11}, function(data,status){
    				playReported = true;
  				});

				// Tracking in Google Analytics
				if (typeof ga !== 'undefined') ga('send', 'event', 'Videos', 'Started', videoTitle);
			};

			var trackVideoEnd = function(){
				// Tracking in our Server
				$.post('/remake/view', {"view_id":objectId, "remake_id":remakeId, "playback_event":1, "originating_screen":11, "total_duration":myPlayer.duration(), "playback_duration":myPlayer.currentTime()}, function(data,status){
    				stopReported = true;
  				});

				// Tracking in Google Analytics
				if (typeof ga !== 'undefined') ga('send', 'event', 'Videos', 'Ended', videoTitle);				
			};

			myPlayer.one("play", trackVideoSrart)
			myPlayer.one("ended", trackVideoEnd)

			// Event for page unload to track the end of the view
			$(window).bind('beforeunload', function(){
				// Tracking only if we already tracked play and didn'y track stop
  				if (playReported && !stopReported) {
	  				// Tracking in our Server (doing a sync call because the page is about to close)
	  				$.ajax({
				        type: 'POST',
				        async: false,
				        url: '/remake/view',
				        data: {"view_id":objectId, "remake_id":remakeId, "playback_event":1, "originating_screen":11, "total_duration":myPlayer.duration(), "playback_duration":myPlayer.currentTime()},
				        complete: function(xhr, status){ }
				    });

					// Tracking in Google Analytics
					if (typeof ga !== 'undefined') ga('send', 'event', 'Videos', 'Ended', videoTitle);				
  				}
  			});
		});

	</script>		
</body>